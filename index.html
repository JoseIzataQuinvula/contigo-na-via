<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MotoJá TOP – Destino Real no Mapa</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/@leaflet/leaflet-routing-machine@latest/dist/leaflet.routing.machine.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; background:#f0f2f10; }
    header { background: linear-gradient(135deg, #ff6b00, #ff8c00); color:white; text-align:center; padding:80px 20px; }
    header h1 { font-size:3rem; margin:0; }
    header p { font-size:1.4rem; margin-top:10px; }

    .container { max-width:1100px; margin:-60px auto 40px; position:relative; z-index:10; }
    .card { background:white; border-radius:25px; box-shadow:0 20px 60px rgba(0,0,0,0.15); overflow:hidden; }

    #map { height:400px; }

    .form { padding:30px; }
    .input-group { margin:15px 0; }
    input, .search-box {
      width:100%; padding:16px; border-radius:12px; border:1px solid #ccc; font-size:1.1rem;
    }
    .search-box { margin:15px 0; }

    .moto-grid {
      display:grid; grid-template-columns:repeat(auto-fit, minmax(150px,1fr)); gap:15px; margin:25px 0;
    }
    .moto { border:3px solid #eee; border-radius:15px; padding:12px; text-align:center; cursor:pointer; transition:.3s; }
    .moto img { width:100%; height:120px; object-fit:cover; border-radius:10px; }
    .moto.selected { border-color:#ff6b00; transform:scale(1.05); box-shadow:0 10px 30px rgba(255,107,0,0.3); }
    .price { font-weight:800; color:#ff6b00; font-size:1.4rem; }

    .price-box {
      text-align:center; padding:20px; background:#fff8f0; border-radius:15px; margin:20px 0;
      font-size:1.8rem; font-weight:800; color:#ff6b00;
    }

    .btn { background:#ff6b00; color:white; border:none; padding:20px; font-size:1.5rem; border-radius:15px; width:100%; cursor:pointer; }
    .btn:hover { background:#e55a00; }

    .status { display:none; padding:30px; text-align:center; background:#f8fff8; }
    .driver { background:white; padding:20px; border-radius:15px; margin:15px 0; box-shadow:0 0 8px 25px rgba(0,0,0,0.1); display:flex; align-items:center; gap:20px; }
    .driver img { width:70px; height:70px; border-radius:50%; }

    .point { background:#ff6b00; color:white; padding:8px 15px; border-radius:30px; font-size:0.9rem; margin:10px 0; display:inline-block; }
  </style>
</head>
<body>

<header>
  <h1>MotoJá TOP</h1>
  <p>Clique no mapa para escolher origem e destino</p>
</header>

<div class="container">
  <div class="card">
    <div id="map"></div>

    <div class="form">
      <div class="input-group">
        <strong><span class="point">Partida</span></strong>
        <input type="text" id="origin" readonly placeholder="Clique no mapa ou permita GPS">
      </div>

      <div class="input-group">
        <strong><span class="point">Destino</span></strong>
        <input type="text" class="search-box" id="destSearch" placeholder="Pesquise ou clique no mapa">
      </div>

      <h3>Escolha o tipo de moto</h3>
      <div class="moto-grid" id="motoGrid"></div>

      <div class="price-box">
        Valor da corrida: <span id="price">Selecione o destino</span>
      </div>

      <input type="text" id="name" placeholder="Seu nome" required style="margin-top:20px;">
      <input type="tel" id="phone" placeholder="WhatsApp (com DDD)" required>

      <button class="btn" id="callBtn">CHAMAR MOTO AGORA</button>
    </div>

    <div class="status" id="status">
      <h2>Procurando mototaxista...</h2>
      <p><strong><span id="views">0</span></strong> viram • <strong><span id="accepts">0</span></strong> aceitaram</p>
      <div id="drivers"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@leaflet/leaflet-routing-machine@latest/dist/leaflet.routing.machine.min.js"></script>

<script>
// MOTOS COM FOTOS REAIS DA INTERNET (alta qualidade)
const motos = [
  {nome:"CG 160 Standard", img:"https://i.imgur.com/5t2o5vP.jpeg", precoKm:850},
  {nome:"PCX 150 Scooter", img:"https://i.imgur.com/2y3vQ3d.jpeg", precoKm:1300},
  {nome:"XRE 190 Adventure", img:"https://i.imgur.com/X7kL9pM.jpeg", precoKm:1100},
  {nome:"CB 250 Twister", img:"https://i.imgur.com/K9pM2vL.jpeg", precoKm:1200},
  {nome:"Fan 160 com Baú", img:"https://i.imgur.com/8nL2pQ1.jpeg", precoKm:950},
  {nome:"NMAX 160 Luxo", img:"https://i.imgur.com/Q8mR9vN.jpeg", precoKm:1600},
];

const map = L.map('map').setView([-8.8383, 13.2344], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let origem = null, destino = null;
let routing = null;
let selectedMoto = motos[0];

// Marcadores
const iconOrigem = L.divIcon({className:'point', html:'Partida', iconSize:[100,40]});
const iconDestino = L.divIcon({className:'point', html:'Chegada', iconSize:[100,40]});

let markerOrigem = null, markerDestino = null;

// GPS automático
navigator.geolocation.getCurrentPosition(p => {
  origem = [p.coords.latitude, p.coords.longitude];
  map.setView(origem, 16);
  markerOrigem = L.marker(origem, {icon: iconOrigem}).addTo(map);
  reverseGeocode(origem, 'origin');
});

// Clique no mapa = escolher ponto
map.on('click', e => {
  if (!origem) {
    origem = [e.latlng.lat, e.latlng.lng];
    if (markerOrigem) map.removeLayer(markerOrigem);
    markerOrigem = L.marker(origem, {icon: iconOrigem}).addTo(map);
    reverseGeocode(origem, 'origin');
  } else if (!destino) {
    destino = [e.latlng.lat, e.latlng.lng];
    if (markerDestino) map.removeLayer(markerDestino);
    markerDestino = L.marker(destino, {icon: iconDestino}).addTo(map);
    reverseGeocode(destino, 'destination');
    calcularRota();
  }
});

// Pesquisa de destino
document.getElementById('destSearch').addEventListener('change', () => {
  const q = document.getElementById('destSearch').value;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}, Luanda`)
    .then(r => r.json())
    .then(d => {
      if (d[0]) {
        destino = [parseFloat(d[0].lat), parseFloat(d[0].lon)];
        map.setView(destino, 15);
        if (markerDestino) map.removeLayer(markerDestino);
        markerDestino = L.marker(destino, {icon: iconDestino}).addTo(map);
        calcularRota();
      }
    });
});

function reverseGeocode(latlng, campo) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng[0]}&lon=${latlng[1]}`)
    .then(r => r.json())
    .then(data => {
      const addr = data.display_name.split(', ').slice(0,4).join(', ');
      document.getElementById(campo).value = addr;
    });
}

function calcularRota() {
  if (!origem || !destino) return;
  if (routing) map.removeControl(routing);

  routing = L.Routing.control({
    waypoints: [L.latLng(origem), L.latLng(destino)],
    createMarker: () => null,
    lineOptions: {styles: [{color:'#ff6b00', weight:8}]},
    router: L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'})
  }).addTo(map);

  routing.on('routesfound', e => {
    const route = e.routes[0];
    const km = (route.summary.totalDistance / 1000).toFixed(1);
    const preco = Math.round(km * selectedMoto.precoKm * 1.35); // + taxa mínima
    document.getElementById('price').innerHTML = `${preco.toLocaleString()} Kz <small>(${km} km)</small>`;
  });
}

// Preenche motos
motos.forEach((m, i) => {
  const div = document.createElement('div');
  div.className = 'moto' + (i===0?' selected':'');
  div.innerHTML = `<img src="${m.img}"><p><strong>${m.nome}</strong></p><p class="price">${m.precoKm} Kz/km</p>`;
  div.onclick = () => {
    document.querySelectorAll('.moto').forEach(x=>x.classList.remove('selected'));
    div.classList.add('selected');
    selectedMoto = m;
    calcularRota(); // recalcula preço se já tem rota
  };
  document.getElementById('motoGrid').appendChild(div);
});

// Botão CHAMAR
document.getElementById('callBtn').onclick = () => {
  if (!origem || !destino) return alert("Escolha origem e destino no mapa!");
  if (!document.getElementById('name').value || !document.getElementById('phone').value) return alert("Preencha nome e telefone!");

  document.querySelector('.form').style.display = 'none';
  document.getElementById('status').style.display = 'block';

  let v = 0, a = 0;
  const interval = setInterval(() => {
    v += Math.floor(Math.random()*4)+1;
    document.getElementById('views').textContent = v;
    if (Math.random() > 0.5 && a < 4) {
      a++;
      document.getElementById('accepts').textContent = a;
      const driver = [
        {n:"António Veloz", f:"https://randomuser.me/api/portraits/men/44.jpg", p:"LD-77-88-AA", t:"3 min"},
        {n:"Beatriz Raio", f:"https://randomuser.me/api/portraits/women/22.jpg", p:"LD-11-22-BB", t:"4 min"},
        {n:"Manuel Turbo", f:"https://randomuser.me/api/portraits/men/67.jpg", p:"LD-33-44-CC", t:"5 min"}
      ][a-1];
      const d = document.createElement('div');
      d.className = 'driver';
      d.innerHTML = `<img src="${driver.f}"><div><strong>${driver.n}</strong> aceitou!<br>Placa ${driver.p} • Chega em ${driver.t}</div>`;
      document.getElementById('drivers').prepend(d);
      if (a===1) clearInterval(interval);
    }
  }, 2000);
};
</script>
</body>
</html>
