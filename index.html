<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contigo na Via – Sua rota em 3 segundos</title>
  <meta name="theme-color" content="#1a73e8">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,sans-serif;background:#f0f2f5;height:100vh;display:flex;flex-direction:column}
    header{background:#1a73e8;color:white;padding:20px;text-align:center}
    h1{font-size:24px;margin:0}
    .content{flex:1;padding:20px;overflow:auto}
    label{display:block;margin:15px 0 8px;font-weight:bold;color:#333}
    input{width:100%;padding:16px;font-size:18px;border:2px solid #ddd;border-radius:12px}
    button{width:100%;padding:18px;margin-top:20px;font-size:20px;background:#34a853;color:white;border:none;border-radius:12px;font-weight:bold;cursor:pointer}
    button:disabled{background:#999;cursor:not-allowed}
    #map{height:480px;width:100%;margin-top:25px;border-radius:16px;border:3px solid #ddd}
    .status{padding:15px;text-align:center;border-radius:12px;margin:15px 0;font-size:18px;font-weight:bold}
    .loading{background:#e3f2fd;color:#1565c0}
    .success{background:#e8f5e9;color:#2e7d32}
    .error{background:#ffebee;color:#c62828}
    .info{background:#e8f5e9;padding:15px;border-radius:12px;text-align:center;margin:15px 0;font-size:18px}
    .gm-err-container,.gm-style .gm-err-container{display:none!important}
  </style>
</head>
<body>

<header><h1>Contigo na Via</h1></header>

<div class="content">
  <label>Sua localização atual</label>
  <input type="text" id="origem" readonly placeholder="Procurando você...">

  <div class="status loading" id="status">Buscando sua localização...</div>

  <label>Para onde você quer ir?</label>
  <input type="text" id="destino" placeholder="Ex: Shopping Eldorado, Praia de Copacabana, trabalho...">

  <button onclick="calcularRota()" id="botaoRota" disabled>Traçar Rota</button>

  <div id="info"></div>
  <div id="map"></div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXdUY1-1VqaKPzSWMnaeAZ_LZy4Cv9QBU&callback=initMap&libraries=places" async defer></script>

<script>
  let map, directionsService, directionsRenderer, markerUsuario;
  let minhaPos = null;

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 4,
      center: { lat: -14.2350, lng: -51.9253 },
      streetViewControl: false
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      polylineOptions: { strokeColor: "#1a73e8", strokeWeight: 8, strokeOpacity: 0.9 }
    });
    directionsRenderer.setMap(map);

    // Autocomplete no destino
    new google.maps.places.Autocomplete(document.getElementById('destino'), {
      fields: ["formatted_address", "geometry", "name"],
      types: ["geocode", "establishment"]
    });

    // Começa a buscar localização automaticamente
    pegarLocalizacao();
  }

  function pegarLocalizacao() {
    const status = document.getElementById('status');

    if (!navigator.geolocation) {
      status.className = "status error";
      status.textContent = "Seu navegador não suporta localização";
      ativarManual();
      return;
    }

    navigator.geolocation.getCurrentPosition(
      pos => {
        minhaPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };

        // ZOOM E CENTRALIZA NO USUÁRIO
        map.setCenter(minhaPos);
        map.setZoom(17);  // Zoom bem próximo (rua visível)

        // Marcador azul grande "Você está aqui"
        if (markerUsuario) markerUsuario.setMap(null);
        markerUsuario = new google.maps.Marker({
          position: minhaPos,
          map: map,
          title: "Você está aqui",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 14,
            fillColor: "#1a73e8",
            fillOpacity: 1,
            strokeColor: "#fff",
            strokeWeight: 5
          },
          animation: google.maps.Animation.DROP
        });

        // Endereço bonito
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: minhaPos }, (results, st) => {
          document.getElementById('origem').value = results?.[0]?.formatted_address || "Minha localização atual";
        });

        status.className = "status success";
        status.textContent = "Localização encontrada! Digite seu destino";
        document.getElementById('botaoRota').disabled = false;
      },
      err => {
        status.className = "status error";
        status.innerHTML = err.code === 1 
          ? "Você bloqueou a localização.<br>Pode digitar o endereço manualmente."
          : "Não conseguimos te localizar.";
        ativarManual();
      },
      { timeout: 15000, enableHighAccuracy: true, maximumAge: 300000 }
    );
  }

  function ativarManual() {
    document.getElementById('origem').readOnly = false;
    document.getElementById('origem').placeholder = "Digite sua rua ou bairro";
    document.getElementById('botaoRota').disabled = false;
  }

  function calcularRota() {
    const destinoInput = document.getElementById('destino').value.trim();
    if (!destinoInput) return alert("Digite para onde você quer ir!");

    const origem = minhaPos || document.getElementById('origem').value;

    if (!origem) return alert("Aguarde sua localização ou digite a origem");

    document.getElementById('info').innerHTML = '<div class="status loading">Traçando a melhor rota...</div>';

    directionsService.route({
      origin: origem,
      destination: destinoInput,
      travelMode: google.maps.TravelMode.DRIVING,
      provideRouteAlternatives: false
    }, (result, status) => {
      if (status === 'OK') {
        directionsRenderer.setDirections(result);
        const leg = result.routes[0].legs[0];
        document.getElementById('info').innerHTML = `
          <div class="info">
            Rota pronta!<br>
            <strong>${leg.distance.text}</strong> • 
            <strong>${leg.duration.text}</strong>
          </div>`;
      } else {
        // Mesmo se falhar, mantém o mapa no usuário
        document.getElementById('info').innerHTML = `
          <div class="status error">
            Não encontramos esse destino exato.<br>
            Tente: <strong>"McDonald's", "Posto Ipiranga", "Praia do Canto"</strong> ou nome da rua
          </div>`;
      }
    });
  }
</script>

</body>
</html>
